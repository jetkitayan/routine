<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Routine 管理</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 16px; background:#fafafa; }
    h1 { font-size: 20px; margin-bottom: 8px; }
    h2 { font-size: 16px; margin-top: 24px; }
    label { display:block; margin-top:8px; }
    textarea {
      width: 100%;
      min-height: 80px;
      padding: 8px;
      box-sizing:border-box;
      font-size:14px;
    }
    button { padding:6px 12px; margin:4px 2px; font-size:14px; }
    table { width:100%; border-collapse:collapse; margin-top:12px; background:#fff; }
    th, td { border:1px solid #ddd; padding:4px 6px; font-size:13px; vertical-align:top; }
    th { background:#eee; }
    .random-box { margin-top:16px; padding:8px; background:#fff; border:1px solid #ddd; }
    .status { margin-top:4px; font-size:12px; color:#555; }
  </style>
</head>
<body>
  <h1>Routine 管理（出かける前・寝る前・起きた後）</h1>

  <section>
    <h2>入力</h2>
    <label>
      ルーチン内容
      <textarea id="text"></textarea>
    </label>
    <button id="createBtn">新規登録</button>
    <button id="updateBtn" disabled>更新</button>
    <button id="cancelEditBtn" disabled>編集キャンセル</button>
    <div id="status" class="status"></div>
  </section>

  <section class="random-box">
    <h2>ランダム表示</h2>
    <button id="randomBtn">ランダムに1件表示</button>
    <button id="editRandomBtn">この内容を編集</button>
  　<div id="randomResult" style="margin-top:8px;"></div>
  </section>

  <section>
    <h2>一覧（hidden=0）</h2>
    <button id="reloadListBtn">一覧を再読み込み</button>
    <table id="listTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>内容</th>
          <th>作成日時</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <script>
    const API_BASE = "https://memo-save-api.jetkitayan.workers.dev"; // 自分の API エンドポイント

    let editingId = null;

    // ★ 注意：Basic 認証の ID/PASS を HTML に直書きすると公開されたときに丸見えなので、
    //  あくまで自分用・プライベート前提。気になるなら別の方法を考える。
    const BASIC_USER = "jet-pay";      // 環境変数 BASIC_USER と合わせる
    const BASIC_PASS = "kibare@1002";  // 環境変数 BASIC_PASS と合わせる

    async function fetchWithBasic(path, options = {}) {
      const headers = options.headers || {};
      headers["Content-Type"] = "application/json";
      headers["Authorization"] = "Basic " + btoa(BASIC_USER + ":" + BASIC_PASS);
      return fetch(API_BASE + path, { ...options, headers });
    }

    function setStatus(msg) {
      document.getElementById("status").textContent = msg || "";
    }

    function resetForm() {
      editingId = null;
      document.getElementById("text").value = "";
      document.getElementById("createBtn").disabled = false;
      document.getElementById("updateBtn").disabled = true;
      document.getElementById("cancelEditBtn").disabled = true;
    }

    async function loadList() {
      const res = await fetchWithBasic("/api/routine");
      const data = await res.json();
      const tbody = document.querySelector("#listTable tbody");
      tbody.innerHTML = "";

      if (!data.ok) {
        setStatus("一覧取得エラー: " + data.error);
        return;
      }

      for (const r of data.routines) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.id}</td>
          <td>${r.text.replace(/\n/g, "<br>")}</td>
          <td>${r.created_at}</td>
          <td>
            <button data-id="${r.id}" data-action="edit">編集</button>
            <button data-id="${r.id}" data-action="delete">削除</button>
          </td>
        `;
        tbody.appendChild(tr);
      }
    }

    async function showRandom() {
      const res = await fetchWithBasic("/api/routine/random?limit=1");
      const data = await res.json();
      const box = document.getElementById("randomResult");

      if (!data.ok || !data.routines || data.routines.length === 0) {
        box.textContent = "データがありません。";
        return;
      }

      const r = data.routines[0];
      box.innerHTML = `
        <div><strong>ID:</strong> ${r.id}</div>
        <div style="margin-top:4px;">${r.text.replace(/\n/g, "<br>")}</div>
      `;
    }

    async function createRoutine() {
      const text = document.getElementById("text").value.trim();
      if (!text) {
        alert("ルーチン内容を入力してください。");
        return;
      }

      const res = await fetchWithBasic("/api/routine", {
        method: "POST",
        body: JSON.stringify({ text }),
      });
      const data = await res.json();

      if (!data.ok) {
        setStatus("登録エラー: " + data.error);
        return;
      }

      setStatus("登録しました (ID: " + data.routine.id + ")");
      resetForm();
      await loadList();
    }

    async function updateRoutine() {
      if (!editingId) return;
      const text = document.getElementById("text").value.trim();
      if (!text) {
        alert("ルーチン内容を入力してください。");
        return;
      }

      const res = await fetchWithBasic(`/api/routine/${editingId}`, {
        method: "PUT",
        body: JSON.stringify({ text }),
      });
      const data = await res.json();

      if (!data.ok) {
        setStatus("更新エラー: " + data.error);
        return;
      }

      setStatus("更新しました (ID: " + data.routine.id + ")");
      resetForm();
      await loadList();
    }

    async function deleteRoutine(id) {
      if (!confirm(`ID ${id} を削除（hidden=1）しますか？`)) return;

      const res = await fetchWithBasic(`/api/routine/${id}`, {
        method: "DELETE",
      });
      const data = await res.json();

      if (!data.ok) {
        setStatus("削除エラー: " + data.error);
        return;
      }

      setStatus("削除しました (ID: " + id + ")");
      await loadList();
    }

    function startEditFromRow(tr) {
      const id = Number(tr.children[0].textContent);
      const textHtml = tr.children[1].innerHTML;
      const text = textHtml.replace(/<br\s*\/?>/gi, "\n");

      editingId = id;
      document.getElementById("text").value = text;

      document.getElementById("createBtn").disabled = true;
      document.getElementById("updateBtn").disabled = false;
      document.getElementById("cancelEditBtn").disabled = false;

      setStatus(`編集中 (ID: ${id})`);
    }

    // イベント設定
    document.getElementById("createBtn").addEventListener("click", createRoutine);
    document.getElementById("updateBtn").addEventListener("click", updateRoutine);
    document.getElementById("cancelEditBtn").addEventListener("click", () => {
      resetForm();
      setStatus("");
    });
    document.getElementById("randomBtn").addEventListener("click", showRandom);

    document.querySelector("#listTable tbody").addEventListener("click", (e) => {
      const btn = e.target.closest("button");
      if (!btn) return;
      const id = Number(btn.dataset.id);
      const action = btn.dataset.action;
      const tr = btn.closest("tr");

      if (action === "edit") {
        startEditFromRow(tr);
      } else if (action === "delete") {
        deleteRoutine(id);
      }
    });

    // 初期処理
    loadList();
  </script>
</body>
</html>
